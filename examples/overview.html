<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>NUTS overview</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://rawgit.com/eurostat/EurostatVisu/gh-pages/js/lib.js"></script>
</head>

<body>
<svg id="map"></svg>
<div id="tooltip"></div>

<script>
	//show loading message
	var loadingDiv = EstLib.loadingImage({imgsrc:"../img/loading.png"});

	//get url parameters for projection, level and width
	var proj = EstLib.getParameterByName("proj") || 3035,
			nutsLvl = EstLib.getParameterByName("lvl") || "3",
			width = EstLib.getParameterByName("s") || 1200,
			year = EstLib.getParameterByName("y") || 2016,

	//build tooltip element
	tooltip = EstLib.tooltip();
	d3.select("#tooltip").style("font-family", "Myriad Pro, Myriad, MyriadPro-Regular, 'Myriad Pro Regular', MyriadPro, 'Myriad Pro', 'Liberation Sans', 'Nimbus Sans L', 'Helvetica Neue', vegur, Vegur, Helvetica, Arial, sans-serif");

	//get data
	d3.json("https://raw.githubusercontent.com/eurostat/Nuts2json/gh-pages/"+year+"/"+proj+"/"+width+"px"+"/"+nutsLvl+".json", function(error, nuts) {
		if (error) return console.error(error);
		loadingDiv.hide();

		//prepare SVG element
		var height = width*(nuts.bbox[3]-nuts.bbox[1])/(nuts.bbox[2]-nuts.bbox[0]),
			svg = d3.select("#map").attr("width", width).attr("height", height),
			path = d3.geoPath().projection(d3.geoIdentity().reflectY(true).fitSize([width,height], topojson.feature(nuts, nuts.objects.gra)))
		;

		//define filter for coastal margin
		svg.append("filter").attr("id","blur").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","4");

        //draw background rectangle
		svg.append("rect").attr("id","bck").attr("x",0).attr("y",0).attr("width", width).attr("height", height).style("fill","#b3cde3");
        //prepare drawing group
		var g = svg.append("g").attr("transform","translate(0,0)");

        //add zooming function
		var zoom;
		svg.call(zoom=d3.zoom().scaleExtent([0.25,6]).on("zoom", function() { g.attr("transform", d3.event.transform); }));

		//draw coastal margin
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntbn).features).enter()
			.append("path").attr("d", path)
			.style("fill","none").style("stroke-width","8px").style("filter","url(#blur)").style("stroke-linejoin","round").style("stroke-linecap","round")
			.style("stroke",function(bn){ if(bn.properties.co==="T") return "white"; return "none"; })
		;
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.nutsbn).features).enter()
			.append("path").attr("d", path)
			.style("fill","none").style("stroke-width","8px").style("filter","url(#blur)").style("stroke-linejoin","round").style("stroke-linecap","round")
			.style("stroke",function(bn){ if(bn.properties.co==="T") return "white"; return "none"; })
		;

		//draw graticule
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.gra).features).enter()
			.append("path").attr("d", path)
			.style("fill","none").style("stroke-width","1px").style("stroke","gray");

		//draw country regions
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntrg).features).enter()
			.append("path").attr("d", path)
			.on("mouseover", function(rg) { d3.select(this).style("fill", "#ddd"); tooltip.mouseover("<b>"+rg.properties.na+"</b><br>"+rg.properties.id); })
			.on("mousemove", function() { tooltip.mousemove(); })
			.on("mouseout", function() { d3.select(this).style("fill", "#f2f2f2"); tooltip.mouseout(); })
			.style("fill","#f2f2f2")
		;

		//draw nuts regions
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.nutsrg).features).enter()
			.append("path").attr("d", path)
			.on("mouseover", function(rg) { d3.select(this).style("fill", "#ff7f00"); tooltip.mouseover("<b>"+rg.properties.na+"</b><br>"+rg.properties.id); })
			.on("mousemove", function() { tooltip.mousemove(); })
			.on("mouseout", function() { d3.select(this).style("fill", "#fdbf6f"); tooltip.mouseout(); })
			.style("fill","#fdbf6f")
		;

		//draw country boundaries
		g.append("g").selectAll("path").data(topojson.feature(nuts, nuts.objects.cntbn).features).enter()
			.append("path").attr("d", path)
			.style("fill","none").style("stroke-width","1.2px")
			.style("stroke",function(bn){ if(bn.properties.co==="T") return "#1f78b4"; return "gray"; })
			.style("stroke-linejoin","round").style("stroke-linecap","round")
		;

		//draw nuts boundaries
		var bn = topojson.feature(nuts, nuts.objects.nutsbn).features;
		bn.sort(function(bn1,bn2){ return bn2.properties.lvl - bn1.properties.lvl; });
		g.append("g").selectAll("path").data(bn).enter()
			.append("path").attr("d", path)
			.style("fill","none")
			.style("stroke",function(bn){
				if(bn.properties.co==="T") return "#1f78b4";
				if(bn.properties.oth==="T" || bn.properties.lvl==0) return "white"; return "#333"; })
			.style("stroke-width",function(bn){ if(bn.properties.lvl==3) return "0.7px"; return "1.2px"; })
			.style("stroke-linejoin","round").style("stroke-linecap","round")
		;
	});

</script>
</body>
